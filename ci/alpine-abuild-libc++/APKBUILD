# Contributor: Dmitry Golovin <dima@golovin.in>
# Contributor: Shiz <hi@shiz.me>
# Maintainer: Shiz <hi@shiz.me>
pkgname=libc++
pkgver=11.1.0
pkgrel=1
_llvmver=${pkgver%%.*}
pkgdesc="A new implementation of the C++ standard library, targeting C++11"
url="https://libcxx.llvm.org/"
arch="all !ppc64le !s390x"
license="UOI-NCSA"
makedepends="cmake
	compiler-rt-static
	linux-headers
	clang>=$_llvmver"
checkdepends="lit"
subpackages="$pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxx-$pkgver.src.tar.xz
        https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libcxxabi-$pkgver.src.tar.xz
        https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/llvm-$pkgver.src.tar.xz
        https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libunwind-$pkgver.src.tar.xz
        avoid-strtoll_l.patch"
builddir="$srcdir"
_libunwinddir="$srcdir/libunwind-$pkgver.src"
_cxxdir="$srcdir/libcxx-$pkgver.src"
_abidir="$srcdir/libcxxabi-$pkgver.src"
_llvmdir="$srcdir/llvm-$pkgver.src"

# Tests on armhf are too slooow, disable them for now.
case "$CARCH" in
	armhf) options="!check";;
esac

prepare() {
	ln -s "$_libunwinddir" "$srcdir"/libunwind
	ln -s "$_cxxdir" "$srcdir"/libcxx
	ln -s "$_abidir" "$srcdir"/libcxxabi
	ln -s "$_llvmdir" "$srcdir"/llvm
	default_prepare
}

# Due a mutual build-time dependency between libc++abi and libc++, it is
# preferable that we build them within the same APKBUILD to avoid duplication.
# Since nothing else seems to need libc++abi and we need to compile it into
# libc++ statically anyway to make -static with libc++ work, we don't actually
# create libc++abi packages. If something arises that depends on libc++abi,
# this may change, but for now this is the simplest approach.
build() {
	mkdir -p "$_libunwinddir"/build
	cd "$_libunwinddir"/build
	cmake .. \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DLLVM_PATH="$_llvmdir" \
		-DLIBUNWIND_ENABLE_SHARED=OFF \
		-DLIBUNWIND_USE_COMPILER_RT=ON
	make -j

	mkdir -p "$_abidir"/build
	cd "$_abidir"/build
	cmake .. \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DCMAKE_SHARED_LINKER_FLAGS="-L$_libunwinddir/build/lib" \
		-DLLVM_PATH="$_llvmdir" \
		-DLIBCXXABI_ENABLE_SHARED=OFF \
		-DLIBCXXABI_LIBUNWIND_PATH="$_libunwinddir" \
		-DLIBCXXABI_LIBUNWIND_INCLUDES="$_libunwinddir"/include \
		-DLIBCXXABI_LIBCXX_INCLUDES="$_cxxdir"/include \
		-DLIBCXXABI_LIBCXX_LIBRARY_PATH="$_cxxdir"/build/lib \
		-DLIBCXXABI_INCLUDE_TESTS=OFF \
		-DLIBCXXABI_USE_COMPILER_RT=ON
	make -j

	mkdir -p "$_cxxdir"/build
	cd "$_cxxdir"/build
	cmake .. \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DLIBCXX_ENABLE_SHARED=OFF \
		-DLIBCXX_HAS_MUSL_LIBC=ON \
		-DLIBCXX_HAS_GCC_S_LIB=OFF \
		-DLIBCXX_CXX_ABI=libcxxabi \
		-DLIBCXX_CXX_ABI_INCLUDE_PATHS="$_abidir"/include \
		-DLIBCXX_CXX_ABI_LIBRARY_PATH="$_abidir"/build/lib \
		-DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=ON \
		-DLIBCXX_USE_COMPILER_RT=ON
	make -j
}

check() {
	cd "$_abidir"/build
	#make check-cxxabi

	cd "$_cxxdir"/build
	# XXX: Some tests fail due to fakeroot currently, and some other due
	# yet-uninvestigated causes.
	#make check-cxx || true
}

package() {
	cd "$_libunwinddir"/build
	make install DESTDIR="$pkgdir"
	cd "$_cxxdir"/build
	make install DESTDIR="$pkgdir"
}

sha512sums="
af5333da5b90f4a46a5184532164f4c6522e3c03a580131627c0f167ab98fb3e71b3e15518d6e22414141484ec5ab0d184294ae7f10034ebfed28e7072836b28  libcxx-11.1.0.src.tar.xz
0bf3806fd9382ca6790ca2a8e991424caf64e81415386875243565034243f2ac7442c596e3c55ece80932c2ec59b71801e3e415dedc9db4dd4c3f66b6a893558  libcxxabi-11.1.0.src.tar.xz
07bf9973384151a18d5cc2892103e5f28a88c632e8e49662fde56d123632f2ed1b3710fa7a87b6b821955d0ec44160ff36f2aa4f233e389e14d628e9bf8dc764  llvm-11.1.0.src.tar.xz
507f29cf1a318d9761fe6306b2e9b57c02a342f138b47ec5420dce527132a33f7affcd386913792c472ceeb9fb1c1b105bba3234a1575aae0f68024e94c8d596  libunwind-11.1.0.src.tar.xz
212bbc1bcbc4628754bdd5bc8a9109fa0032790a3c80517a647a26ee27c22daa417303a72b6cc92cfc099dcc7fd9a36e9d8899165ebe4a5ab14030eaa596bc9c  avoid-strtoll_l.patch
"
